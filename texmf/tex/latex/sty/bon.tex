\begin{pycode}
import json
from pathlib import Path

from bon.puid import fetch_file
from bon.rc import HOME, MODULE_NAME, TEX_SEP


def boninclude(puid: str, env: str) -> str:
    db_file_path = Path(HOME) / MODULE_NAME / fetch_file(puid)
    res = "Initialization text. If you're seeing this,\
        it means that the code has a loophole which\
        I missed while debugging!"

    if env in (
        "problem",
        "exercise",
        "problem*",
        "exercise*",
        "example",
        "example*",
    ):
        try:
            with db_file_path.open("r", encoding="utf-8") as f:
                db_content = json.load(f)

            res = db_content["problem"].split("\n")

            bonhook = f"  \\bonhook{{{puid}}}"
            if env in (
                "problem",
                "exercise",
                "problem*",
                "exercise*",
            ):
                res.insert(1, bonhook)

            if env in (
                "example",
                "example*",
            ):
                res.append(bonhook)

            if db_content["source"]:
                source_list = []
                for source in db_content["source"]:
                    if next(iter(source.values())):
                        source_list.append(
                            f"\\href{{{next(iter(source.values()))}}}{{{next(iter(source))}}}"
                        )
                    else:
                        source_list.append(next(iter(source)))
                source = "  [" + ", ".join(source_list) + "]"
                res.insert(1, source)

            res = "\n".join(res)
            res = res.replace("\\begin{problem*}", f"\\begin{{{env}}}")
            res = res.replace("\\end{problem*}", f"\\end{{{env}}}")
        except Exception as e:
            res = f"[Error: {e}]"

    elif env in ("soln", "solution"):
        try:
            with db_file_path.open("r", encoding="utf-8") as f:
                db_content = json.load(f)

            bon_soln_list = db_content["solution"]
            final_soln_list = []

            if len(bon_soln_list) == 1:
                res = bon_soln_list[0]
            elif len(bon_soln_list) >= 2:
                for i, soln in enumerate(bon_soln_list):
                    soln = soln.replace(
                        "\\begin{soln}",
                        f"\\begin{{proof}}[Solution {i+1}.]\\renewcommand{{\\qedsymbol}}{{$\\blacksquare$}}",
                    )
                    soln = soln.replace("\\end{soln}", "\\end{proof}")
                    final_soln_list.append(soln)
                res = ("\n" + TEX_SEP + "\n").join(final_soln_list)
        except Exception as e:
            res = f"[Error: {e}]"
    else:
        res = "Incorrect environment!"
    return res
\end{pycode}
